<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prorate Calculator</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;
    padding:20px;
}
.container{
    max-width:1200px;
    margin:auto;
    background:#fff;
    border-radius:12px;
    box-shadow:0 10px 40px rgba(0,0,0,.2);
    padding:32px;
}
h1{
    font-size:24px;
    font-weight:600;
    margin-bottom:32px;
    color:#1a1a1a;
}
.section-title{
    font-size:17px;
    font-weight:600;
    margin-bottom:16px;
    border-bottom:2px solid #667eea;
    padding-bottom:8px;
    color:#1a1a1a;
}
.section-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:16px;
}
.table-wrapper{
    overflow-x:auto;
    margin-bottom:20px;
}
table{
    width:100%;
    border-collapse:collapse;
    min-width:650px;
}
th{
    background:#667eea;
    color:#fff;
    padding:12px 10px;
    font-size:13px;
    white-space:nowrap;
    font-weight:600;
}
td{
    padding:10px;
    border-bottom:1px solid #ddd;
    font-size:14px;
}
tbody tr:hover td{background:#f8f9ff}
input{
    width:100%;
    padding:8px 10px;
    border:2px solid #ddd;
    border-radius:6px;
    font-size:13px;
    transition:border .2s;
}
input:focus{
    border-color:#667eea;
    outline:none;
    box-shadow:0 0 0 3px rgba(102,126,234,0.1);
}
.btn{
    padding:10px 16px;
    border:none;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
    font-size:13px;
    margin:0 8px 8px 0;
    transition:transform .1s,box-shadow .2s;
    display:inline-flex;
    align-items:center;
    gap:6px;
}
.btn:hover{
    transform:translateY(-1px);
    box-shadow:0 4px 8px rgba(0,0,0,.15);
}
.btn:active{transform:translateY(0)}
.btn-add{background:#4caf50;color:#fff}
.btn-reset{background:#ff9800;color:#fff}
.btn-remove{
    background:#f44336;
    color:#fff;
    font-size:12px;
    padding:6px 10px;
}
.input-group{
    margin-bottom:20px;
}
.input-group label{
    display:block;
    font-weight:600;
    font-size:14px;
    margin-bottom:6px;
    color:#333;
}
.input-group input{
    padding:10px 12px;
    font-size:15px;
}
.number{
    text-align:right;
    font-family:monospace;
    font-size:13px;
}
.empty-state{
    text-align:center;
    color:#999;
    padding:24px;
    font-size:13px;
}
.totals-row{
    background:#f5f5f5;
    font-weight:700;
}
.totals-row td{
    font-size:14px;
    padding:12px 10px;
}
.high-discount{background:#fff3cd}
.toggle-container{
    display:flex;
    align-items:center;
    gap:10px;
}
.toggle-label{
    font-size:13px;
    color:#555;
    font-weight:500;
}
.toggle-switch{
    position:relative;
    display:inline-block;
    width:46px;
    height:24px;
}
.toggle-switch input{
    opacity:0;
    width:0;
    height:0;
}
.slider{
    position:absolute;
    cursor:pointer;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:#ccc;
    transition:all .3s;
    border-radius:24px;
}
.slider:before{
    position:absolute;
    content:"";
    height:18px;
    width:18px;
    left:3px;
    bottom:3px;
    background:white;
    transition:all .3s;
    border-radius:50%;
    box-shadow:0 2px 4px rgba(0,0,0,.2);
}
input:checked + .slider{background:#667eea}
input:checked + .slider:before{transform:translateX(22px)}
.decimal-selector{
    padding:5px 10px;
    border:2px solid #667eea;
    border-radius:6px;
    font-size:12px;
    background:white;
    cursor:pointer;
    transition:all .3s;
    opacity:0;
    transform:scale(0.95);
    pointer-events:none;
}
.decimal-selector.active{
    opacity:1;
    transform:scale(1);
    pointer-events:all;
}
.decimal-selector:hover{background:#f0f4ff}
.button-group{
    display:flex;
    gap:8px;
    margin-bottom:24px;
    flex-wrap:wrap;
}
.history-btn{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    background:#667eea;
    color:#fff;
    border:none;
    border-radius:50%;
    width:24px;
    height:24px;
    font-size:14px;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .2s;
    font-weight:bold;
}
.history-btn:hover{
    background:#5568d3;
    transform:translateY(-50%) scale(1.1);
}
.history-popup{
    position:absolute;
    background:#fff;
    border:2px solid #667eea;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,.15);
    z-index:1000;
    min-width:280px;
    max-width:350px;
}
.history-header{
    background:#667eea;
    color:#fff;
    padding:10px 14px;
    font-weight:600;
    font-size:13px;
    border-radius:6px 6px 0 0;
}
.history-list{
    max-height:200px;
    overflow-y:auto;
    padding:8px;
}
.history-item{
    padding:8px 10px;
    border-bottom:1px solid #eee;
    font-size:13px;
}
.history-item:last-child{
    border-bottom:none;
}
.history-item:hover{
    background:#f8f9ff;
}
.history-expr{
    font-family:monospace;
    color:#333;
    font-weight:500;
    margin-bottom:3px;
}
.history-time{
    font-size:11px;
    color:#999;
}
.history-list::-webkit-scrollbar{
    width:6px;
}
.history-list::-webkit-scrollbar-track{
    background:#f1f1f1;
    border-radius:3px;
}
.history-list::-webkit-scrollbar-thumb{
    background:#667eea;
    border-radius:3px;
}
.history-list::-webkit-scrollbar-thumb:hover{
    background:#5568d3;
}
@media (max-width: 768px){
    .container{padding:20px}
    h1{font-size:20px}
    .section-header{
        flex-direction:column;
        align-items:flex-start;
        gap:12px;
    }
    table{font-size:12px}
    th,td{padding:8px}
}
</style>

</head>

<body>
<div class="container">
<h1>Prorate Calculator</h1>

<h2 class="section-title">List</h2>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Name</th>
<th>Original Amount (â‚¹)</th>
<th>Action</th>
</tr>
</thead>
<tbody id="itemRows"></tbody>
</table>
</div>

<div class="button-group">
<button class="btn btn-add" onclick="addItem()">âž• Add Item</button>
<button class="btn btn-reset" onclick="resetAll()">ðŸ”„ Reset</button>
</div>

<div class="input-group">
<label for="totalBill">Total Bill Amount (â‚¹):</label>
<div style="position:relative">
<input type="text" id="totalBill" value="" placeholder="Enter amount or expression (e.g., 45-34)" style="padding-right:35px">
<button class="history-btn" data-field="totalBill" title="View calculation history" style="position:absolute;right:8px;top:50%;transform:translateY(-50%)">â“˜</button>
</div>
</div>

<div class="input-group">
<label for="afterDiscount">Total Bill After Discount (â‚¹):</label>
<div style="position:relative">
<input type="text" id="afterDiscount" value="" placeholder="Enter amount or expression (e.g., 100x0.8)" style="padding-right:35px">
<button class="history-btn" data-field="afterDiscount" title="View calculation history" style="position:absolute;right:8px;top:50%;transform:translateY(-50%)">â“˜</button>
</div>
</div>

<div class="section-header">
<h2 class="section-title" style="margin-bottom:0;border:none;padding-bottom:0">Proration Result</h2>
<div class="toggle-container">
<span class="toggle-label">Custom Decimals</span>
<label class="toggle-switch">
<input type="checkbox" id="decimalToggle">
<span class="slider"></span>
</label>
<select id="decimalSelector" class="decimal-selector">
<option value="0">0 decimals</option>
<option value="1">1 decimal</option>
<option value="2" selected>2 decimals</option>
<option value="3">3 decimals</option>
<option value="4">4 decimals</option>
</select>
</div>
</div>

<div class="table-wrapper">
<table>
<thead>
<tr>
<th>Item</th>
<th>Original (â‚¹)</th>
<th>Proportion</th>
<th>Prorated (â‚¹)</th>
<th>Discount (â‚¹)</th>
</tr>
</thead>
<tbody id="outputRows">
<tr><td colspan="5" class="empty-state">Add items to see calculations</td></tr>
</tbody>
<tfoot>
<tr class="totals-row">
<td>TOTAL</td>
<td id="tOriginal" class="number">â‚¹0.000</td>
<td class="number">100%</td>
<td id="tProrated" class="number">â‚¹0.000</td>
<td id="tDiscount" class="number">â‚¹0.000</td>
</tr>
</tfoot>
</table>
</div>
</div>

<script>
let items=[];
let nextId=1;
let useCustomDecimals=false;
let decimalPlaces=2;
let calculationHistory={};

function addItem(){
    items.push({id:nextId++,name:'',amount:0});
    renderTable();
}

function removeItem(id){
    if(items.length===1){
        alert('At least one item required');
        return;
    }
    items=items.filter(m=>m.id!==id);
    renderTable();
}

function updateName(id, val){
    const m=items.find(x=>x.id===id);
    if(m) m.name=val;
}

function updateAmount(id, val){
    const m=items.find(x=>x.id===id);
    if(m){
        m.amount=parseFloat(val)||0;
        calculate();
    }
}

function evaluateExpression(expr){
    try{
        // Remove spaces and replace x or X with *
        expr = expr.replace(/\s/g, '').replace(/x|X/gi, '*');
        // Safely evaluate the expression
        const result = Function('"use strict"; return (' + expr + ')')();
        return isFinite(result) ? result : 0;
    }catch(e){
        return null;
    }
}

function addToHistory(fieldId, expression, result){
    if(!calculationHistory[fieldId]){
        calculationHistory[fieldId] = [];
    }
    // Only add if it's actually a calculation (contains operators)
    if(/[\+\-\*\/xX\(\)]/.test(expression)){
        calculationHistory[fieldId].unshift({
            expr: expression,
            result: result,
            time: new Date().toLocaleTimeString()
        });
        // Keep only last 20
        if(calculationHistory[fieldId].length > 20){
            calculationHistory[fieldId].pop();
        }
    }
}

function showHistory(fieldId, inputElement){
    hideAllHistories();
    
    const history = calculationHistory[fieldId] || [];
    if(history.length === 0) return;
    
    const rect = inputElement.getBoundingClientRect();
    const popup = document.createElement('div');
    popup.className = 'history-popup';
    popup.id = 'active-history';
    popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
    popup.style.left = (rect.left + window.scrollX) + 'px';
    
    let html = '<div class="history-header">Calculation History</div><div class="history-list">';
    history.forEach((item, idx) => {
        html += `<div class="history-item">
            <div class="history-expr">${item.expr} = ${item.result}</div>
            <div class="history-time">${item.time}</div>
        </div>`;
    });
    html += '</div>';
    popup.innerHTML = html;
    
    document.body.appendChild(popup);
}

function hideAllHistories(){
    const existing = document.getElementById('active-history');
    if(existing) existing.remove();
}

function renderTable(){
    const tbody=document.getElementById('itemRows');
    const focusedId=document.activeElement?.dataset?.id;
    const focusedType=document.activeElement?.className;
    const cursorPos=document.activeElement?.selectionStart;
    
    tbody.innerHTML='';
    
    items.forEach(m=>{
        const tr=document.createElement('tr');
        
        tr.innerHTML=`
        <td>
            <input type="text" value="${m.name}" data-id="${m.id}" class="name-input"
                placeholder="Enter name">
        </td>
        <td style="position:relative">
            <input type="text" value="${m.amount||''}" data-id="${m.id}" class="amount-input"
                placeholder="0 or 45-34 or 23+67.467" style="padding-right:35px">
            <button class="history-btn" data-field="item-${m.id}" title="View calculation history">â“˜</button>
        </td>
        <td>
            <button class="btn btn-remove" data-id="${m.id}">âœ•</button>
        </td>`;
        tbody.appendChild(tr);
    });
    
    tbody.querySelectorAll('.name-input').forEach(input=>{
        input.addEventListener('input', (e)=>{
            updateName(parseInt(e.target.dataset.id), e.target.value);
        });
    });
    
    tbody.querySelectorAll('.amount-input').forEach(input=>{
        input.addEventListener('input', (e)=>{
            updateAmount(parseInt(e.target.dataset.id), e.target.value);
        });
        input.addEventListener('keydown', (e)=>{
            if(e.key === 'Enter'){
                e.preventDefault();
                const expr = e.target.value;
                const result = evaluateExpression(expr);
                if(result !== null){
                    const fieldId = 'item-' + e.target.dataset.id;
                    addToHistory(fieldId, expr, result);
                    e.target.value = result;
                    updateAmount(parseInt(e.target.dataset.id), result.toString());
                }
            }
        });
    });
    
    tbody.querySelectorAll('.history-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            e.stopPropagation();
            const fieldId = e.target.dataset.field;
            const input = tbody.querySelector(`[data-id="${fieldId.split('-')[1]}"].amount-input`);
            showHistory(fieldId, input);
        });
    });
    
    tbody.querySelectorAll('.btn-remove').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
            removeItem(parseInt(e.target.dataset.id));
        });
    });
    
    if(focusedId){
        const elementToFocus=tbody.querySelector(`[data-id="${focusedId}"].${focusedType}`);
        if(elementToFocus){
            elementToFocus.focus();
            if(cursorPos!==undefined && elementToFocus.setSelectionRange){
                elementToFocus.setSelectionRange(cursorPos, cursorPos);
            }
        }
    }
    
    calculate();
}

function calculate(){
    const totalBill=parseFloat(totalBillInput.value)||0;
    const after=parseFloat(afterDiscountInput.value)||0;

    if(after>totalBill && totalBill>0){
        afterDiscountInput.value=totalBill;
        return;
    }

    const totalOriginal=items.reduce((s,m)=>s+m.amount,0);
    const out=document.getElementById('outputRows');
    out.innerHTML='';

    if(!totalOriginal || totalBill===0){
        out.innerHTML='<tr><td colspan="5" class="empty-state">Add items and amounts to see calculations</td></tr>';
        tOriginal.textContent=tProrated.textContent=tDiscount.textContent='â‚¹0.000';
        return;
    }

    const decimals=useCustomDecimals?decimalPlaces:3;
    
    let sumProrated=0, sumDiscount=0;

    items.forEach(m=>{
        if(!m.amount) return;
        const prop=(m.amount/totalBill)*100;
        const prorated=(m.amount/totalBill)*after;
        const discount=m.amount-prorated;
        sumProrated+=prorated;
        sumDiscount+=discount;

        const tr=document.createElement('tr');
        tr.innerHTML=`
        <td>${m.name||'Unnamed'}</td>
        <td class="number">â‚¹${m.amount.toFixed(3)}</td>
        <td class="number">${prop.toFixed(3)}%</td>
        <td class="number">â‚¹${prorated.toFixed(decimals)}</td>
        <td class="number ${discount/m.amount>0.5?'high-discount':''}">â‚¹${discount.toFixed(decimals)}</td>`;
        out.appendChild(tr);
    });

    tOriginal.textContent='â‚¹'+totalOriginal.toFixed(3);
    tProrated.textContent='â‚¹'+sumProrated.toFixed(decimals);
    tDiscount.textContent='â‚¹'+sumDiscount.toFixed(decimals);
}

function resetAll(){
    items=[{id:1,name:'',amount:0}];
    nextId=2;
    totalBillInput.value='';
    afterDiscountInput.value='';
    decimalToggle.checked=false;
    useCustomDecimals=false;
    decimalSelector.classList.remove('active');
    decimalSelector.value='2';
    decimalPlaces=2;
    renderTable();
}

const totalBillInput=document.getElementById('totalBill');
const afterDiscountInput=document.getElementById('afterDiscount');
const decimalToggle=document.getElementById('decimalToggle');
const decimalSelector=document.getElementById('decimalSelector');

totalBillInput.addEventListener('input', calculate);
afterDiscountInput.addEventListener('input', calculate);

totalBillInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
        e.preventDefault();
        const expr = e.target.value;
        const result = evaluateExpression(expr);
        if(result !== null){
            addToHistory('totalBill', expr, result);
            e.target.value = result;
            calculate();
        }
    }
});

afterDiscountInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
        e.preventDefault();
        const expr = e.target.value;
        const result = evaluateExpression(expr);
        if(result !== null){
            addToHistory('afterDiscount', expr, result);
            e.target.value = result;
            calculate();
        }
    }
});

document.querySelectorAll('.history-btn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
        e.stopPropagation();
        const fieldId = e.target.dataset.field;
        const input = document.getElementById(fieldId);
        showHistory(fieldId, input);
    });
});

document.addEventListener('click', (e)=>{
    if(!e.target.closest('.history-popup') && !e.target.closest('.history-btn')){
        hideAllHistories();
    }
});

decimalToggle.addEventListener('change', (e)=>{
    useCustomDecimals=e.target.checked;
    decimalSelector.classList.toggle('active', useCustomDecimals);
    calculate();
});

decimalSelector.addEventListener('change', (e)=>{
    decimalPlaces=parseInt(e.target.value);
    calculate();
});

items=[{id:1,name:'',amount:0}];
nextId=2;
renderTable();
</script>

</body>
</html>
